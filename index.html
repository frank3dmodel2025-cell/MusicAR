<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini WebAR</title>
<style>
  html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: sans-serif;}
  #three-container { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
  video#camera-feed { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0; }
  #placement-dot {
    position:absolute; width:50px; height:50px; border-radius:50%;
    background:rgba(0,150,255,0.5); border:2px solid #00f; 
    top:50%; left:50%; transform:translate(-50%,-50%);
    z-index:2; touch-action:none;
  }
  #ar-controls { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:3; display:flex; gap:10px; }
  button { padding:10px 15px; font-size:16px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; }
</style>
</head>
<body>

<video id="camera-feed" autoplay muted playsinline></video>
<div id="three-container"></div>
<div id="placement-dot"></div>
<div id="ar-controls">
  <button id="btn-place">Colocar Modelo</button>
  <button id="btn-scale-up">+</button>
  <button id="btn-scale-down">-</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

let scene, camera, renderer;
let modelContainer = null;
let currentModel = null;
let anchorPosition = new THREE.Vector3();
let placementDot = document.getElementById('placement-dot');
let cameraVideo = document.getElementById('camera-feed');

// --- Inicializar Three.js ---
function initThree(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
  camera.position.set(0,0,0);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  document.getElementById('three-container').appendChild(renderer.domElement);

  const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
  scene.add(light);

  modelContainer = new THREE.Group();
  scene.add(modelContainer);

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

// --- Activar cámara ---
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
    cameraVideo.srcObject = stream;
    cameraVideo.play();
  }catch(e){
    alert('No se pudo acceder a la cámara.');
    console.error(e);
  }
}

// --- Cargar modelo 3D de prueba ---
const loader = new GLTFLoader();
async function loadModel(){
  return new Promise((resolve,reject)=>{
    loader.load('https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf',
    (gltf)=>{
      currentModel = gltf.scene;
      const box = new THREE.Box3().setFromObject(currentModel);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      currentModel.position.sub(center);
      const scaleFactor = 0.5 / Math.max(size.x, size.y, size.z);
      currentModel.scale.setScalar(scaleFactor);
      currentModel.visible = false;
      modelContainer.add(currentModel);
      resolve();
    }, undefined, (err)=>{ console.error(err); reject(err); });
  });
}

// --- Render loop ---
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}

// --- Colocar modelo en la posición del placement dot ---
function placeModel(){
  if(!currentModel) return;
  const x = (placementDot.offsetLeft + placementDot.offsetWidth/2)/window.innerWidth*2-1;
  const y = -((placementDot.offsetTop + placementDot.offsetHeight/2)/window.innerHeight*2-1);

  const vector = new THREE.Vector3(x, y, 0.5).unproject(camera);
  const dir = vector.sub(camera.position).normalize();
  const distance = 2; // metros delante de la cámara
  anchorPosition.copy(camera.position.clone().add(dir.multiplyScalar(distance)));

  modelContainer.position.copy(anchorPosition);
  currentModel.visible = true;
}

// --- Escalar modelo ---
function scaleModel(factor){
  if(!currentModel) return;
  currentModel.scale.multiplyScalar(factor);
}

// --- Drag placement dot ---
let dragging=false, offsetX=0, offsetY=0;
placementDot.addEventListener('pointerdown', e=>{
  dragging=true;
  offsetX = e.clientX - placementDot.offsetLeft;
  offsetY = e.clientY - placementDot.offsetTop;
});
placementDot.addEventListener('pointermove', e=>{
  if(!dragging) return;
  let nx = e.clientX - offsetX;
  let ny = e.clientY - offsetY;
  nx = Math.max(0, Math.min(window.innerWidth-50, nx));
  ny = Math.max(0, Math.min(window.innerHeight-50, ny));
  placementDot.style.left = nx+'px';
  placementDot.style.top = ny+'px';
});
placementDot.addEventListener('pointerup', e=>{ dragging=false; });

// --- Botones ---
document.getElementById('btn-place').addEventListener('click', placeModel);
document.getElementById('btn-scale-up').addEventListener('click', ()=>scaleModel(1.1));
document.getElementById('btn-scale-down').addEventListener('click', ()=>scaleModel(0.9));

// --- Inicialización ---
initThree();
startCamera();
loadModel().then(animate);

</script>
</body>
</html>
