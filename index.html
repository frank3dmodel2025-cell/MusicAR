<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR - Casco 3D (Todo en uno)</title>

    <!-- 
      SECCIÓN DE ESTILOS (CSS)
      Todo el CSS que estaba en style.css ahora está dentro de esta etiqueta <style>.
    -->
    <style>
        /* Estilos generales para resetear márgenes y asegurar que ocupe toda la pantalla */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            color: #fff;
            background-color: #111;
        }

        /* El contenedor principal donde se añadirá el botón y el lienzo */
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* El lienzo (canvas) donde se renderiza la escena 3D */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* 
          El botón de AR (generado por ARButton.js) se posicionará por defecto.
          Podemos añadir un estilo personalizado si quisiéramos.
        */
        #ARButton {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border: 1px solid #fff;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 999;
        }
    </style>

    <!-- 
      IMPORT MAP
      Define cómo el navegador encuentra los módulos de three.js directamente desde la web.
      Esto nos permite usar "import" en nuestro script sin un paso de compilación.
    -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <!-- El botón de AR y el lienzo de renderizado se añadirán aquí mediante JavaScript -->
    <div id="container"></div>

    <!-- 
      SECCIÓN DE LÓGICA (JavaScript)
      Todo el código que estaba en main.js ahora está dentro de esta etiqueta <script>.
      Es importante que tenga el atributo "type='module'" para que los "import" funcionen.
    -->
    <script type="module">
        // --- 1. IMPORTACIONES ---
        // Importamos los módulos necesarios de la librería three.js
        import * as THREE from 'three';
        // ARButton nos crea un botón para entrar a la experiencia AR de forma sencilla
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        // GLTFLoader nos permite cargar modelos en formato glTF/glb, el estándar para la web
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 2. VARIABLES GLOBALES ---
        // Estas variables necesitan ser accesibles en varias funciones
        let camera, scene, renderer;
        let model; // Variable para almacenar nuestro modelo 3D
        let controller;

        // --- 3. INICIALIZACIÓN ---
        // Llamamos a la función principal para empezar todo
        init();

        function init() {
            // Obtenemos el contenedor del HTML
            const container = document.getElementById('container');

            // --- ESCENA ---
            // La escena es el contenedor de todos los objetos 3D, luces y cámaras
            scene = new THREE.Scene();

            // --- CÁMARA ---
            // La cámara define el punto de vista. En AR, su posición y rotación
            // serán controladas por el dispositivo físico.
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // --- RENDERER ---
            // El renderer dibuja la escena en la pantalla (en un elemento <canvas>)
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // Habilitamos el soporte para WebXR
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            // --- BOTÓN DE AR ---
            // Creamos el botón para iniciar la sesión de AR.
            // El botón comprobará si el dispositivo es compatible.
            const arButton = ARButton.createButton(renderer, {
                requiredFeatures: ['hit-test'] // 'hit-test' es opcional pero útil para detectar superficies
            });
            container.appendChild(arButton);

            // --- LUCES ---
            // Añadimos luces para que el modelo 3D no se vea plano y oscuro.
            // Luz ambiental: ilumina todos los objetos de la escena de manera uniforme.
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // Luz direccional: simula la luz del sol.
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(2, 3, 4);
            scene.add(directionalLight);

            // --- CARGA DEL MODELO 3D ---
            // Usamos GLTFLoader para cargar el modelo del casco.
            const loader = new GLTFLoader();
            const modelURL = 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf';
            
            loader.load(
                modelURL,
                // Función que se ejecuta cuando el modelo se ha cargado correctamente
                function (gltf) {
                    model = gltf.scene;
                    
                    // Inicialmente, el modelo no es visible hasta que el usuario lo coloque
                    model.visible = false;

                    // Opcional: Escalar el modelo si es muy grande o muy pequeño
                    model.scale.set(0.2, 0.2, 0.2);

                    scene.add(model);
                    console.log("Modelo 3D cargado correctamente.");
                },
                // Función de progreso (opcional)
                undefined,
                // Función que se ejecuta si hay un error al cargar
                function (error) {
                    console.error('Error al cargar el modelo 3D:', error);
                }
            );

            // --- CONTROLADOR (INTERACCIÓN) ---
            // WebXR usa un "controlador" para gestionar las interacciones, como un toque en la pantalla.
            controller = renderer.xr.getController(0);
            // Añadimos un listener para el evento 'select' (toque en la pantalla)
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // --- CICLO DE ANIMACIÓN ---
            // setAnimationLoop es la forma correcta de crear un bucle de renderizado para WebXR.
            renderer.setAnimationLoop(renderLoop);

            // --- RESPONSIVIDAD ---
            // Ajustar la cámara y el renderer si la ventana cambia de tamaño
            window.addEventListener('resize', onWindowResize);
        }

        // --- 4. FUNCIÓN DE INTERACCIÓN (onSelect) ---
        function onSelect() {
            // Esta función se llama cuando el usuario toca la pantalla.
            if (model && !model.visible) {
                // Si el modelo está cargado pero no es visible, lo colocamos en la escena.
                // Lo posicionamos un poco delante de la cámara.
                // La posición (0, 0, -1) es 1 metro delante de la cámara.
                model.position.set(0, 0, -1).applyMatrix4(controller.matrixWorld);
                model.quaternion.setFromRotationMatrix(controller.matrixWorld);
                
                // Hacemos visible el modelo
                model.visible = true;
            }
        }

        // --- 5. BUCLE DE RENDERIZADO (renderLoop) ---
        function renderLoop() {
            // Esta función se ejecuta en cada frame (unas 60 veces por segundo).
            
            // Si el modelo existe y está visible, lo hacemos rotar suavemente.
            if (model && model.visible) {
                model.rotation.y += 0.005; // Rotación sobre el eje Y
            }

            // Renderizamos la escena desde la perspectiva de la cámara.
            renderer.render(scene, camera);
        }

        // --- 6. FUNCIÓN DE AJUSTE DE VENTANA (onWindowResize) ---
        function onWindowResize() {
            // Actualizamos la relación de aspecto de la cámara
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            // Actualizamos el tamaño del renderer
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
